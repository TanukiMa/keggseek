# .github/workflows/crawler.yml
name: New Word Crawler Pipeline (Sequential Build)

on:
  schedule:
    # 6時間ごとに実行 (0時, 6時, 12時, 18時 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: 3. Install dependencies
        run: pip install requests beautifulsoup4 supabase configparser
      - name: 4. Run URL Discoverer
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python discover_urls.py

  process:
    needs: discover
    runs-on: ubuntu-latest
    timeout-minutes: 350
    strategy:
      matrix:
        instance: [1]
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: 3. Install all dependencies
        run: |
          pip install sudachipy SudachiDict-full
          pip install requests beautifulsoup4 supabase configparser
      
      - name: 4. Build User Dictionary Source from Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python build_dict_source.py
      
      - name: 4a. Display Generated Dictionary Source for Debugging
        if: always()
        run: |
          echo "--- Contents of user_dict_source.csv (first 10 lines) ---"
          head -n 10 user_dict_source.csv || echo "user_dict_source.csv not found or is empty."
          echo "----------------------------------------------------------"
        
      - name: 5. Compile User Dictionary Binary
        run: |
          SYSTEM_DICT_PATH=$(python -c "import sudachidict_full, os; print(os.path.join(os.path.dirname(sudachidict_full.__file__), 'resources', 'system.dic'))")
          echo "Found system dictionary at: ${SYSTEM_DICT_PATH}"

          if [ -s user_dict_source.csv ]; then
            echo "CSV source found. Compiling user dictionary..."
            sudachipy ubuild -s "${SYSTEM_DICT_PATH}" -o user.dict user_dict_source.csv
            echo "USER_DICT_PATH=user.dict" >> $GITHUB_ENV
          else
            echo "User dictionary source is empty. Skipping build."
            echo "USER_DICT_PATH=" >> $GITHUB_ENV
          fi

      - name: 6. Run Queue Processor
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          USER_DICT_PATH: ${{ env.USER_DICT_PATH }}
        run: python process_queue.py
